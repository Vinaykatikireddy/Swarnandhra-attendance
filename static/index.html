<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Student Dashboard</title>

<style>
:root{
  --bg-gradient: linear-gradient(180deg, #fffafc 0%, #fff6ff 100%);
  --card-bg: linear-gradient(135deg, #f5f0ff 0%, #fff0f8 100%);
  --border: rgba(118,75,162,0.18);
  --accent: #7c4dff;
  --accent-2: #ff6fb5;
  --muted: #7b6f85;
  --text: #1f1b2e;
  font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont;
}

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
}

body{
  background: var(--bg-gradient);
  color:var(--text);
}

.page{
  min-height:calc(100vh - 62.4px);
}

.topnav {
  background: white;
  border-bottom: 1px solid #ddd;
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.logo img {
  width: 200px;
}

.navbar-toggler {
  display: none;
  font-size: 24px;
  background-color: #ef81b6;
  height: 50px;
  border: none;
  cursor: pointer;
  align-items: center;
  justify-content: center;
}

.navbar-nav {
  list-style: none;
  display: flex;
  gap: 20px;
  margin: 0;
  padding: 0;
}

.nav-item {
  cursor: pointer;
  padding: 6px 10px;
}

.nav-item:hover {
  background: #f1f1f1;
}

/* Mobile */
@media (max-width: 991px) {
  .navbar-toggler{
    display: flex;
  }
  .navbar-collapse {
    display: none;
    position: absolute;
    top: 70px;
    right: 16px;
    background: white;
    border: 1px solid #ddd;
    padding: 10px;
  }

  .navbar-collapse.show {
    display: block;
  }

  .navbar-nav {
    flex-direction: column;
    gap: 10px;
  }
}


.container{
  max-width:1280px;
  margin:auto;
  padding:40px 16px;
}

.card{
  background: var(--card-bg);
  border:1px solid var(--border);
  border-radius:16px;
  padding:24px;
  margin-bottom:24px;
  color:var(--text);
}

input, button{
  padding:14px;
  margin:2px;
  border-radius:10px;
  font-size:15px;
}

input{
  width:100%;
  max-width:420px;
  background: #ffffff;
  border:1px solid var(--border);
  color:var(--text);
}

button{
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  border:none;
  font-weight:600;
  cursor:pointer;
  color:white;
}

.student-card{
  background: linear-gradient(135deg,#f8f5ff 0%, #fff3fb 100%);
  border:1px solid var(--border);
  border-radius:16px;
  padding:22px;
  margin-bottom:22px;
  color:var(--text);
}

.student-card h4{
  color:var(--accent);
  margin-bottom:16px;
}

.student-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:14px;
}

.student-item{
  background: rgba(255,255,255,0.88);
  border:1px solid var(--border);
  border-radius:10px;
  padding:12px;
  overflow-wrap:anywhere;
  word-break:break-word;
}

.label{
  color:var(--muted);
  font-size:12px;
}

.value{
  font-weight:600;
  color:var(--text);
}

.attendance-wrapper{
  overflow-x:auto;
}

.attendance-wrapper table{
  width:99%;
  border-collapse:collapse;
  font-size:clamp(11px,1.2vw,14px);
  background: #ffffff;
}

.attendance-wrapper th,
.attendance-wrapper td{
  border:1px solid rgba(118,75,162,0.08);
  padding:6px;
  text-align:center;
  color:var(--text);
}

.attendance-wrapper thead th{
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
  color: white;
  font-weight:600;
}


#ctl00_cpStudCorner_pnMarks {
  max-width: 100%;
  overflow-x: auto;
}
#ctl00_cpStudCorner_pnMarks > table {
  transform: scale(1);
  transform-origin: top left;
  transition: transform 0.2s ease;
}

@media (max-width: 768px) {
  #ctl00_cpStudCorner_pnMarks > table {
    transform: scale(0.9);
  }
}
@media (max-width: 480px) {
  #ctl00_cpStudCorner_pnMarks > table {
    transform: scale(0.8);
  }
}
#ctl00_cpStudCorner_pnMarks td {
  font-size: clamp(0.75rem, 1vw, 0.9rem);
  white-space: nowrap;
}


.modal{
  position:fixed;
  inset:0;
  background:rgba(124,77,255,0.06);
  backdrop-filter:blur(6px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
}

.modal ul{
  margin-left:40px;
}
  
.modal.hidden{ display:none }

.modal-box{
  background: #ffffff;
  border:1px solid var(--border);
  border-radius:16px;
  width:min(95%,1100px);
  max-height:85vh;
  display:flex;
  flex-direction:column;
  color:var(--text);
}

.modal-header{
  padding:16px 20px;
  display:flex;
  justify-content:space-between;
  border-bottom:1px solid rgba(118,75,162,0.06);
}

.modal-body{
  padding:20px;
  overflow:auto;
}

.close-btn{
  background:none;
  border:none;
  color:var(--muted);
  font-size:22px;
  cursor:pointer;
}

.loader {
  border: 8px solid #ffffff;
  border-top: 8px solid var(--accent);
  margin-top: 15px;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 2s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

footer{
  text-align:center;
  padding:20px;
  color:var(--muted);
  border-top:1px solid rgba(118,75,162,0.06);
}
</style>
</head>

<body>

<div class="page">
  <div class="topnav">
  <div class="logo">
    <a href="https://swarnandhra-student-dashboard.vercel.app/">
      <img src="https://www.swarnandhra.ac.in/img/logo/swarnandhra-logo.png" alt="Swarnandhra Logo">
    </a>
  </div>

  <button class="navbar-toggler" onclick="toggleNav()">‚ò∞</button>

  <div class="navbar-collapse" id="main_nav">
    <ul class="navbar-nav">
      <li class="nav-item" onclick="showNewFeatures()">New features</li>
      <li class="nav-item" onclick="showIssues()">Issues</li>
      <li class="nav-item" onclick="showHowItWorks()">How this works</li>
      <li class="nav-item" onclick="showAboutMe()">About me</li>
      <li class="nav-item" onclick="displayFeedbackForm()">feedback</li>
    </ul>
  </div>
</div>
  
  <div class="container">
    <div class="card">
      
      <h2>Student Dashboard</h2><br>
      <form id="form">
        <input id="regid" placeholder="Enter Name or Registration Number" required>
        <br><br>
        <button>View Details</button>
      </form>
    </div>
    <div style="width:100%;" class="card" id="useful_links">
      <h2>Useful Links</h2><br>
      <ul style="list-style-type: disc;margin-left:25px;">
        <li><a href="https://www.swarnandhra.ac.in" target="_blank">Swarnandhra official website</a></li>
        <li><a href="https://www.swarnandhraexambranch.com" target="_blank">Swarnandhra results portal</a></li>
        <li><a href="javascript:void(0);" onclick="showscet2024();">2024-28 students data</a></li>
        <li><a href="/static/bus_route_map/index.html">Bus routes re-designed</a></li>
      </ul>
    </div>
    <div id="output_block"></div>
    
  </div>
</div>

<footer>
  Credits <a href="https://swarnandhra.ac.in">swarnandhra.ac.in</a> ¬∑ Developed by <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQvtjLvKzjN7W4s1dYhrVaKjCabdgjh_En1wriRC1iw3KfppE4YVZYsGj64tQxQict3qW4q9j6meK4x/pubhtml"><strong>Vinay</strong></a>
</footer>

<script>
 // if (window.location.hostname !== "swarnandhra-student-dashboard.vercel.app") {
//    window.location.href = "https://swarnandhra-student-dashboard.vercel.app";
  //}


const form = document.getElementById('form');
const regidInput = document.getElementById('regid');
const output_block = document.getElementById('output_block');

let modal = document.querySelector('.modal');
if(!modal){
  modal = document.createElement('div');
  modal.className = 'modal hidden';
  modal.innerHTML = `
    <div class="modal-box">
      <div class="modal-header">
        <h3 id="modalTitle" style="align-items: center;display: flex;justify-content: center;">Modal</h3>
        <button class="close-btn">&times;</button>
      </div>
      <div class="modal-body" id="modalContent">Loading...</div>
    </div>`;
  document.body.appendChild(modal);
}
const modalContent = modal.querySelector('#modalContent');
const modalTitle = modal.querySelector('#modalTitle');
modal.querySelector('.close-btn').onclick = () => modal.classList.add('hidden');

function toggleNav() {
  document.getElementById("main_nav").classList.toggle("show");
}
function showNewFeatures() {
  modalTitle.textContent = 'New features';
  modalContent.innerHTML = `<div><ul>
      <li>Name searching (full name preferred).</li>
      <li>Added Inter memo for more students.</li>
      <li>Added SQL LIKE pattern matching (first match shown).</li>
      <li>Added queue system to handle concurrent requests without overlapping.</li>
      <li>Added useful links to navigate to other websites & data</li>
      <li>Added attendance for students of all semesters</li>
      <li>multiple students glob.</li>
    </ul></div>`;
  modal.classList.remove('hidden');
}
function showIssues() {
  modalTitle.textContent = 'Issues & upcoming Features';
  modalContent.innerHTML = `<div><ul>
      <li>backend processing very slowly.</li>
      <li>results box have to fit on the mobile screen.</li>
      <li>check logs and stop users seeing data often without giving feedback.</li>
    </ul></div>`;
  modal.classList.remove('hidden');
}
function showHowItWorks() {
  modalTitle.textContent = 'How this website works';
  modalContent.innerHTML = `<div>Your registration number can reveal so much of your personal information.<br> Using publicly available sources, this website combines information such as college details, results, and date of birth from the official college examination portal, along with additional details like intermediate hall ticket number from third-party result portals. These details may then be used to retrieve EAPCET application information from the APSCHE website.<br> At present, the source of attendance data and mobile number cannot be disclosed. Please note that this platform only consolidates publicly accessible information and does not collect or store private data.<br> If any external source becomes unavailable or restricts access, the system may display limited or basic information only.</div>`;
  modal.classList.remove('hidden');
}
function showAboutMe() {
  modalTitle.textContent = 'About Me';
  modalContent.innerHTML = `<div>Hello, I'm <strong>Vinay</strong>, a Computer Science Engineering student from the 2024‚Äì2028 batch.<br> I built this website with a simple goal, to help students avoid paying condonation fees due to low attendance. Please check your attendance periodically. Avoid checking multiple times in a short span.<br> If you find this useful, don‚Äôt forget to share it with your friends.</div>`;
  modal.classList.remove('hidden');
}

function showscet2024(){
  modalTitle.textContent = 'SCET 2024 Students Data';
  modalContent.innerHTML = `<div style="height:500px;"><iframe  style="width:100%;height:100%;align-items:center;display:flex;justify-content: center;" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTmWk_jJJ5jF8ZIb4NurdpHkwxSedQ_2Ev4ueHjHd_9PtUrIz5sDPTD7JpZSWSTfQ/pubhtml?widget=true&amp;headers=false"></iframe></div>`;
  modal.classList.remove('hidden');
}

async function fetchWithQueue(
  url,
  options = {},
  {
    retryDelay = 4000,
    maxRetries = 15,
    onRetry = null,
    onSlow = null,
    slowAfter = 2000
  } = {}
) {
  let attempt = 0;

  while (true) {
    let slowTimer;
    let slowTriggered = false;

    if (typeof onSlow === 'function') {
      slowTimer = setTimeout(() => {
        slowTriggered = true;
        onSlow();
      }, slowAfter);
    }

    let res;
    try {
      res = await fetch(url, options);
    } finally {
      clearTimeout(slowTimer);
    }

    if (res.status === 429) {
      attempt++;

      if (attempt > maxRetries) {
        throw new Error('Server is busy for too long.');
      }

      if (typeof onRetry === 'function') {
        onRetry(attempt);
      }

      await new Promise(r => setTimeout(r, retryDelay));
      continue;
    }

    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }

    return res;
  }
}




function showMessage(html){ output_block.innerHTML = `<div class="card">${html}</div>`; }

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  output_block.innerHTML = '';


  let regid = regidInput.value.trim();
  if (!regid) return showMessage('Please enter a registration number.');
  regid = '%'+regid+'%'
  regid = regid.replaceAll(' ', '%');


  const btn = form.querySelector('button');
  btn.disabled = true;

  if (!btn._oldText) btn._oldText = btn.textContent;
  btn.textContent = 'Loading...';

  if (!btn._loader) {
    const loader = document.createElement('div');
    loader.className = 'loader';
    btn._loader = loader;
    btn.parentNode.insertBefore(loader, btn.nextSibling);
  }

  try {
    const res = await fetchWithQueue('/student', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ regid })
    }, {
  onSlow: () => {
    btn.textContent = 'Loading...';
  }, 
      onRetry: (attempt) => {
        btn.textContent = `Server busy: Queued‚Ä¶ retrying (${attempt})`;
      }
  });

    let data = '';
    data = await res.json();

    if (data.mode === 'error')
      return showMessage(data.message || 'Error fetching student');

    useful_links.style.display = 'none';
    if ('mode' in data) {
      renderStudentCard(data.student || {}, true);
    } else {
      Object.values(data).forEach(student => {
        renderStudentCard(student, false);
      });
    }

  } catch (err) {
    showMessage('Request failed: ' + (err.message || err));
  } finally {
    displayFeedbackForm();
    let last_part = '';
    last_part += `<br><br><button style="margin-left:5px" onclick="sharePage()">Share this website</button>`;
    last_part += `<br><br><p style="margin-left:5px">If anything is wrong, simply try again after some time.</p>`;
    output_block.appendChild(document.createRange().createContextualFragment(last_part));
    btn.disabled = false;
    if (btn._loader) {
      btn._loader.remove();
      delete btn._loader;
    }
    btn.textContent = btn._oldText || 'View Details';
    delete btn._oldText;
  }
});

function renderStudentCard(student, single_user){
  const card = document.createElement('div');
  card.className = 'student-card';

  let html = "";
  html += `<div style="display:flex;gap:12px;align-items:flex-start;justify-content:center;margin-bottom:14px">`;
  let collegeImg = student.college_image || '';
  let appPhoto = student.eapcet_photo || '';
  if(collegeImg){ html += `<div><img src="${collegeImg}" alt="College" style="max-width:150px;display:block;border-radius:10px"></div>`; }
  if (appPhoto) { html += `<div style="width:150px;height:200px;border-radius:8px;background-image:url('${appPhoto}');background-size:100% 100%;background-position:center;background-repeat:no-repeat;display:block;"></div>`; }

  collegeImg = '';
  appPhoto = '';

  html += `</div>`;

  html += `<h4 style="text-align:center;">${student.Name || student.name || 'Student'}</h4>`;

  html += `<div class="student-grid">`;
  for(const [k,v] of Object.entries(student)){
    
    if(v === null || typeof v === 'object') continue;
    const keyLower = k.toLowerCase();
    if(['eapcet_application','eapcet_photo', 'inter_memo'].includes(keyLower)) continue;
    if(keyLower.includes('college_image') || keyLower.includes('photo') || keyLower.includes('name') || keyLower.includes('lab section')) continue;
    
    html += `
      <div class="student-item">
        <div class="label">${k.toUpperCase()}</div>
        <div class="value">${v}</div>
      </div>`;
  }

  html += `</div><div style="margin-top:12px;gap:10px;align-items:center;flex-wrap:wrap">`;
  
  const rid = student.regid||"";
  semester = student.Semester.slice(4)||"Fourth semester";
  console.log(semester, student);
  const eapApp = btoa(unescape(encodeURIComponent(student.eapcet_application || '')));
  if(rid) html += `<br><button onclick="onViewAttendance('${rid}', '${semester}')">View Attendanceüòç</button>`;
  if(rid && single_user) html += `<button onclick="onViewResults('${rid}')">View College Results</button>`;
  if(student.inter_memo){ html += `<button onclick="onViewInterMemo('${student.inter_memo}')">View Inter Memo</button>`; }
  if(eapApp){ html += `<button onclick="onViewEapcetApp('${eapApp}')">View EAPCET Application</button>`; }
  

  card.innerHTML = html;
  output_block.appendChild(card);
}

function displayFeedbackForm() {
  const card = document.createElement("div");
  card.className = "card";
  card.id = "feedback-card";

  card.innerHTML = `
    <h2>Share feedback</h2><br>
    <form id="feedback-form">
      <input 
        id="feedback" 
        name="feedback" 
        placeholder="Type your suggestions & issues" 
        required
      >
      <br><br>
      <button type="submit">Submit</button><br><br><i>welcoming contributions</i>
    </form>
  `;

  output_block.appendChild(card);
}

document.addEventListener("submit", (e) => {
  if (e.target.id !== "feedback-form") return;

  e.preventDefault();

  const form = e.target;
  const feedbackInput = form.querySelector("#feedback");
  const card = document.getElementById("feedback-card");

  card.innerHTML = `<h3>Thank you for your feedback.</h3>`;

  fetchWithQueue("/feedback", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      feedback: feedbackInput.value
    })
  }, {
  onSlow: () => {
    btn.textContent = 'loading...';
  }, 
  onRetry: (attempt) => {
    btn.textContent = `Queued‚Ä¶ retrying (${attempt})`;
  }
}).catch(err => {
    console.error("Feedback submit failed:", err);
  });
});



async function onViewAttendance(regid, semester){
  modalTitle.textContent = 'Attendance';
  modalContent.innerHTML = 'Loading attendance...';
  modal.classList.remove('hidden');

  try {
    const res = await fetchWithQueue(
  '/attendance',
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({ regid, semester }),
  },
  {
    onSlow: () => {
      modalContent.innerHTML = `<div class="attendance-wrapper">loading...</div>`;
    },
    onRetry: (attempt) => {
      modalContent.innerHTML = `<div class="attendance-wrapper">Queued‚Ä¶ retrying (${attempt})</div>`;
    },
  }
);

    const data = await res.json();
    let html = data.html;

    modalContent.innerHTML = `<div class="attendance-wrapper">${html}</div>`;
  }
  catch(err){
    modalContent.innerHTML = 'Failed to load attendance: '+err.message;
  }
}

function sharePage() {
  if (navigator.share) {
    navigator.share({
      title: document.title,
      url: window.location.href
    });
  } else {
    alert("Sharing not supported. Copy this link:\n" + window.location.href);
  }
}

function onViewResults(regid){
  modalTitle.textContent = 'Results';
  modalContent.innerHTML = 'Loading results...';
  modal.classList.remove('hidden');

  try {
    (async () => {
        const res = await fetch(
          '/results',
          {
            method: 'POST',
            headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            },
          body: new URLSearchParams({ regid }),
          }
        );
        if(res.status === 429){
          modalContent.innerHTML = `<div>Server is busy. Please try again later.</div>`;
          return;
        }
        const data = await res.json();
    
        let html = data.html||"No results available.";

        modalContent.innerHTML = `<div>${html}</div>`;
    })();
  }
  catch(err){
    modalContent.innerHTML = 'Failed to load results: '+err.message;
  }
}

function onViewInterMemo(interMemo){
  const base64 = interMemo || student.inter_memo || '';
  if(!base64) return showMessage('Inter memo not available');

  const blob = base64ToBlob(base64, 'application/pdf');
  if(!blob) return showMessage('Failed to prepare inter memo');
  const url = URL.createObjectURL(blob);

  if(window.innerWidth < 1200){
    const a = document.createElement('a');
    a.href = url;
    a.download = 'inter_memo.pdf';
    document.body.appendChild(a);
    a.click();
    a.remove();
    
    setTimeout(() => URL.revokeObjectURL(url), 1500);
    return;
  }

  modalTitle.textContent = 'Inter Memo';
  modalContent.innerHTML = `<div style="height:70vh"><iframe src="${url}" style="width:100%;height:100%" frameborder="0"></iframe></div><div style="margin-top:8px"><a href="${url}" download="inter_memo.pdf">Download PDF</a></div>`;
  modal.classList.remove('hidden');
}

function onViewEapcetApp(eapApp){
  if(!eapApp) return showMessage('EAPCET application not available');

  modalTitle.textContent = 'EAPCET Application';

  let html = '';

  try {
    html = decodeURIComponent(escape(atob(eapApp)));
  } catch (err) {
    return showMessage('Failed to decode EAPCET application');
  }

  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);

  modalContent.innerHTML = `
    <iframe
      src="${url}"
      style="width:100%;height:70vh;border:none;background:white"
      sandbox="allow-same-origin allow-scripts allow-forms"
    ></iframe>

    <div style="margin-top:8px">
      <a href="${url}" download="eapcet_application.html">
        Download HTML
      </a>
    </div>
  `;

  modal.classList.remove('hidden');
}


function base64ToBlob(base64, mime){ try{ const bytes = atob(base64); const len = bytes.length; const out = new Uint8Array(len); for(let i=0;i<len;i++) out[i]=bytes.charCodeAt(i); return new Blob([out], {type: mime}); }catch(e){ return null; } }
</script>

</body>
</html>
</script>

</body>
</html>
