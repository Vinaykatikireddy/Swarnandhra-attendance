<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Student Dashboard</title>

<style>
/* ROOT VARIABLES (purple + pink + white theme) */
:root{
  --bg-gradient: linear-gradient(180deg, #fffafc 0%, #fff6ff 100%);
  --card-bg: linear-gradient(135deg, #f5f0ff 0%, #fff0f8 100%);
  --border: rgba(118,75,162,0.18);
  --accent: #7c4dff; /* purple */
  --accent-2: #ff6fb5; /* pink */
  --muted: #7b6f85;
  --text: #1f1b2e;
  font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont;
}

/* RESET & BASE */
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
}

body{
  background: var(--bg-gradient);
  color:var(--text);
}

/* PAGE WRAPPER (pushes footer naturally) */
.page{
  min-height:calc(100vh - 80px); /* footer space */
  padding-bottom:40px;
}

/* CONTAINER */
.container{
  max-width:1280px;            /* wider layout */
  margin:auto;
  padding:40px 16px;
}

/* GENERIC CARD */
.card{
  background: var(--card-bg);
  border:1px solid var(--border);
  border-radius:16px;
  padding:24px;
  margin-bottom:24px;
  color:var(--text);
}

/* FORM */
input, button{
  padding:14px;
  margin:2px;
  border-radius:10px;
  font-size:15px;
}

input{
  width:100%;
  max-width:420px;
  background: #ffffff;
  border:1px solid var(--border);
  color:var(--text);
}

button{
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  border:none;
  font-weight:600;
  cursor:pointer;
  color:white;
}

/* STUDENT CARD */
.student-card{
  background: linear-gradient(135deg,#f8f5ff 0%, #fff3fb 100%);
  border:1px solid var(--border);
  border-radius:16px;
  padding:22px;
  margin-bottom:22px;
  color:var(--text);
}

.student-card h4{
  color:var(--accent);
  margin-bottom:16px;
}

/* Responsive grid — auto grows based on content */
.student-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:14px;
}

/* Individual info block */
.student-item{
  background: rgba(255,255,255,0.88);
  border:1px solid var(--border);
  border-radius:10px;
  padding:12px;
  overflow-wrap:anywhere;   /* prevents overflow */
  word-break:break-word;
}

.label{
  color:var(--muted);
  font-size:12px;
}

.value{
  font-weight:600;
  color:var(--text);
}

/* ATTENDANCE TABLE */
.attendance-wrapper{
  overflow-x:auto;
}

/* Font auto-adjusts */
.attendance-wrapper table{
  width:99%;
  border-collapse:collapse;
  font-size:clamp(11px,1.2vw,14px);
  background: #ffffff;
}

.attendance-wrapper th,
.attendance-wrapper td{
  border:1px solid rgba(118,75,162,0.08);
  padding:6px;
  text-align:center;
  color:var(--text);
}

/* Table header uses purple-pink gradient */
.attendance-wrapper thead th{
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
  color: white;
  font-weight:600;
}


#ctl00_cpStudCorner_pnMarks {
  max-width: 100%;
  overflow-x: auto;      /* contain zoom */
}
#ctl00_cpStudCorner_pnMarks > table {
  transform: scale(1);
  transform-origin: top left;
  transition: transform 0.2s ease;
}
/* Mobile scaling */
@media (max-width: 768px) {
  #ctl00_cpStudCorner_pnMarks > table {
    transform: scale(0.9);
  }
}
@media (max-width: 480px) {
  #ctl00_cpStudCorner_pnMarks > table {
    transform: scale(0.8);
  }
}
#ctl00_cpStudCorner_pnMarks td {
  font-size: clamp(0.75rem, 1vw, 0.9rem);
  white-space: nowrap;
}


/* MODAL (used only for multiple students) */
.modal{
  position:fixed;
  inset:0;
  background:rgba(124,77,255,0.06);
  backdrop-filter:blur(6px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
}

.modal.hidden{ display:none }

.modal-box{
  background: #ffffff;
  border:1px solid var(--border);
  border-radius:16px;
  width:min(95%,1100px);
  max-height:85vh;
  display:flex;
  flex-direction:column;
  color:var(--text);
}

.modal-header{
  padding:16px 20px;
  display:flex;
  justify-content:space-between;
  border-bottom:1px solid rgba(118,75,162,0.06);
}

.modal-body{
  padding:20px;
  overflow:auto;
}

.close-btn{
  background:none;
  border:none;
  color:var(--muted);
  font-size:22px;
  cursor:pointer;
}

/* Loader (large as requested) */
.loader {
  border: 16px solid #ffffff; /* Light */
  border-top: 16px solid var(--accent); /* Purple */
  border-radius: 50%;
  width: 120px;
  height: 120px;
  animation: spin 2s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* FOOTER */
footer{
  text-align:center;
  padding:20px;
  color:var(--muted);
  border-top:1px solid rgba(118,75,162,0.06);
}
</style>
</head>

<body>

<div class="page">
  <div class="container">

    <!-- SEARCH CARD -->
    <div class="card">
      <h2>Student Dashboard</h2>
      <form id="form">
        <input id="regid" placeholder="Registration Number" required>
        <br><br>
        <button>View Details</button>
      </form>
    </div>

    <!-- RESULT AREA -->
    <div id="results"></div>

  </div>
</div>

<footer>
  Credits swarnandhra.ac.in · Developed by <strong>Vinay</strong>
</footer>

<script>
// Frontend adapted: images above details, explicit action buttons, no auto-attendance
const form = document.getElementById('form');
const regidInput = document.getElementById('regid');
const results = document.getElementById('results');

// Ensure modal exists
let modal = document.querySelector('.modal');
if(!modal){
  modal = document.createElement('div');
  modal.className = 'modal hidden';
  modal.innerHTML = `
    <div class="modal-box">
      <div class="modal-header">
        <h3 id="modalTitle">Modal</h3>
        <button class="close-btn">&times;</button>
      </div>
      <div class="modal-body" id="modalContent">Loading...</div>
    </div>`;
  document.body.appendChild(modal);
}
const modalContent = modal.querySelector('#modalContent');
const modalTitle = modal.querySelector('#modalTitle');
modal.querySelector('.close-btn').onclick = () => modal.classList.add('hidden');

function showMessage(html){ results.innerHTML = `<div class="card">${html}</div>`; }
function findRegId(student){ for(const k of Object.keys(student)){ if(k.toLowerCase().includes('A2')) return student[k]; } return student.regid || student.RegNo || student.Reg || ''; }
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  results.innerHTML = '';

  const regid = regidInput.value.trim();
  if (!regid) return showMessage('Please enter a registration number.');

  const btn = form.querySelector('button');
  btn.disabled = true;

  if (!btn._oldText) btn._oldText = btn.textContent;
  btn.textContent = 'loading...';

  if (!btn._loader) {
    const loader = document.createElement('div');
    loader.className = 'loader';
    btn._loader = loader;
    btn.parentNode.insertBefore(loader, btn.nextSibling);
  }

  try {
    const res = await fetch('/student', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ regid })
    });

    if (!res.ok) throw new Error('Error');

    const data = await res.json();

    if (data.mode === 'error')
      return showMessage(data.message || 'Error fetching student');

    if (data.mode === 'basic' || data.mode === 'full') {
      renderStudentCard(data.student || {}, data.files || {});
      return;
    }

    showMessage('Unexpected response from server');
  } catch (err) {
    showMessage('Request failed: ' + (err.message || err));
  } finally {
    btn.disabled = false;
    if (btn._loader) {
      btn._loader.remove();
      delete btn._loader;
    }
    btn.textContent = btn._oldText || 'View Details';
    delete btn._oldText;
  }
});

function renderStudentCard(student, files){
  results.innerHTML = '';
  const card = document.createElement('div');
  card.className = 'student-card';

  // Images section (above details) — show college image and application photo side-by-side
  let html = `<div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:14px">`;
  const collegeImg = files.college_image || student.college_image || files.collegeImage || '';
  const appPhoto = files.photo_base64 || files.photo || '';
  if(collegeImg){ html += `<div><img src="${collegeImg}" alt="College" style="max-width:150px;border-radius:8px;display:block"></div>`; }
  if(appPhoto){ html += `<div><img src="${appPhoto}" alt="Photo" style="max-width:150px;border-radius:8px;display:block"></div>`; }
  html += `</div>`;

  html += `<h4>${student.Name || student.name || 'Student'}</h4>`;

  // Basic details grid — exclude large fields and binary fields
  html += `<div class="student-grid">`;
  for(const [k,v] of Object.entries(student)){
    // skip objects and big/html fields
    if(v === null || typeof v === 'object') continue;
    const keyLower = k.toLowerCase();
    if(['eapcet_application','eapcetapplication','eapcet_application_html'].includes(keyLower)) continue;
    if(keyLower.includes('college_image') || keyLower.includes('photo') ) continue;

    html += `
      <div class="student-item">
        <div class="label">${k.toUpperCase()}</div>
        <div class="value">${v}</div>
      </div>`;
  }

  html += `</div><div style="margin-top:12px;gap:10px;align-items:center;flex-wrap:wrap">`;

  // Action buttons: Attendance, Results, Inter Memo, EAPCET Application
  const rid = findRegId(student);
  if(rid) html += `<button onclick="onViewAttendance('${rid}')">View Attendance</button>`;
  html += `<button onclick="onViewResults('${rid}')">View Results</button>`;
  if(files.inter_memo){ html += `<button onclick="onViewInterMemo()">View Inter Memo</button>`; }
  if(student.Eapcet_application){ html += `<button onclick="onViewEapcetApp()">View EAPCET Application</button>`; }


  card.innerHTML = html;
  results.appendChild(card);

  // Store currently displayed data on card element for later use
  card._student = student;
  card._files = files;
}

// Handlers for actions
async function onViewAttendance(regid){
  modalTitle.textContent = 'Attendance';
  modalContent.innerHTML = 'Loading attendance...';
  modal.classList.remove('hidden');

  try {
    const res = await fetch('/attendance', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:new URLSearchParams({ regid }) });
    const data = await res.json();
    let html = data.html;

    modalContent.innerHTML = `<div class="attendance-wrapper">${html}</div>`;
  }
  catch(err){
    modalContent.innerHTML = 'Failed to load attendance: '+err.message;
  }
}


function onViewInterMemo(){
  // find current card data
  const card = results.querySelector('.student-card');
  if(!card) return showMessage('No student loaded');
  const files = card._files || {};
  const base64 = files.inter_memo;
  if(!base64) return showMessage('Inter memo not available');

  const blob = base64ToBlob(base64, 'application/pdf');
  if(!blob) return showMessage('Failed to prepare inter memo');
  const url = URL.createObjectURL(blob);

  // If viewport is narrow (mobile/tablet), auto-download instead of showing modal
  if(window.innerWidth < 1200){
    const a = document.createElement('a');
    a.href = url;
    a.download = 'inter_memo.pdf';
    // Some browsers require the link to be in the document
    document.body.appendChild(a);
    a.click();
    a.remove();
    // Revoke URL after a short delay
    setTimeout(() => URL.revokeObjectURL(url), 1500);
    return;
  }

  // Desktop/tablet behavior: show in modal with iframe and download link
  modalTitle.textContent = 'Inter Memo';
  modalContent.innerHTML = `<div style="height:70vh"><iframe src="${url}" style="width:100%;height:100%" frameborder="0"></iframe></div><div style="margin-top:8px"><a href="${url}" download="inter_memo.pdf">Download PDF</a></div>`;
  modal.classList.remove('hidden');
}

function onViewResults(regid){
  modalTitle.textContent = 'Results';
  modalContent.innerHTML = 'Loading results...';
  modal.classList.remove('hidden');

  try {
    (async () => {
        const res = await fetch('/results', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:new URLSearchParams({ regid }) });
        const data = await res.json();
    
        let html = data.html;

        modalContent.innerHTML = `<div>${html}</div>`;
    })();
  }
  catch(err){
    modalContent.innerHTML = 'Failed to load results: '+err.message;
  }
}


function onViewEapcetApp(){
  const card = results.querySelector('.student-card');
  if(!card) return showMessage('No student loaded');
  const student = card._student || {};
  const html = student.Eapcet_application || student.EapcetApplication || '';
  if(!html) return showMessage('EAPCET application not available');

  modalTitle.textContent = 'EAPCET Application';
  // create blob for download
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  modalContent.innerHTML = `<div style="max-height:70vh;color:black;overflow:auto;border:1px solid rgba(255,255,255,0.04);padding:8px;background:#060812">${html}</div><div style="margin-top:8px"><a href="${url}" download="application.html">Download HTML</a></div>`;
  modal.classList.remove('hidden');
}

function onViewEapcetApp(){
  const card = results.querySelector('.student-card');
  if(!card) return showMessage('No student loaded');
  const student = card._student || {};
  const html = student.Eapcet_application || student.EapcetApplication || '';
  if(!html) return showMessage('EAPCET application not available');

  modalTitle.textContent = 'EAPCET Application';
  // create blob for download
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  modalContent.innerHTML = `<div style="max-height:70vh;color:black;overflow:auto;border:1px solid rgba(255,255,255,0.04);padding:8px;background:#060812">${html}</div><div style="margin-top:8px"><a href="${url}" download="application.html">Download HTML</a></div>`;
  modal.classList.remove('hidden');
}

function base64ToBlob(base64, mime){ try{ const bytes = atob(base64); const len = bytes.length; const out = new Uint8Array(len); for(let i=0;i<len;i++) out[i]=bytes.charCodeAt(i); return new Blob([out], {type: mime}); }catch(e){ return null; } }
</script>

</body>
</html>
</script>

</body>
</html>
